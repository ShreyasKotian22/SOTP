<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>View Sales Order</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    html, body {
      height: 100%;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
    }
    * {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

body {
  display: flex;
  background-color: #f5f6f8;
  height: 100vh;
  overflow: hidden;
}

/* Container Layout */
.container {
  display: flex;
  width: 100%;
  height: 100vh;
}

/* Sidebar */
.sidebar {
  width: 280px;
  background-color: #006D7D;
  color: white;
  display: flex;
  flex-direction: column;
  padding: 20px 0;
}

.sidebar .logo img {
  width: 245px;
  margin: 0 auto 20px;
  display: block;
}

.sidebar nav ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.sidebar nav ul li {
  padding: 12px 30px;
  cursor: pointer;
  font-size: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: background 0.3s;
}

    .nav-item i,
.logout i {
  font-size: 18px;
}

.nav-item:hover {
  background-color: rgba(255, 255, 255, 0.25);
  cursor: pointer;
}


.logout {
  padding: 12px 30px;
  cursor: pointer;
  font-size: 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: auto;
}

.nav-item i,
.logout i {
  font-size: 18px;
  margin-right: 8px; /* spacing between icon and text */
  vertical-align: middle;
  width: 18px;        /* uniform width */
  height: 22px;       /* uniform height */
  display: inline-block;
}


/* Main content */
.main-content {
  flex: 1;
  padding: 30px 40px;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  overflow: hidden;
}

    .main-content h1 {
      font-size: 24px;
      font-weight: 700;
      color: #111;
      margin-bottom: 25px;
    }

    .custom-filter-group {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-bottom: 20px;
    }

    .custom-dropdown {
      position: relative;
    }

    .dropdown-btn {
      background-color: #006D7D;
      color: white;
      padding: 8px 16px;
      border: none;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      width: 220px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      z-index: 10;
      padding: 10px;
    }

    .dropdown-content input {
      width: 100%;
      padding: 6px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .dropdown-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 150px;
      overflow-y: auto;
    }

    .dropdown-list li {
      padding: 8px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dropdown-list li:hover {
      background-color: #f0f0f0;
    }

    .table-wrapper {
      background-color: #E0F1F5;
      border-radius: 12px;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px;
      font-size: 14px;
      text-align: center;
    }

    thead {
      background-color: #006D7D;
      color: white;
    }

    tbody tr:nth-child(odd) {
      background-color: #CDE6EA;
    }

    tbody tr:nth-child(even) {
      background-color: #E0F1F5;
    }

    .edit-icon {
      color: #007bff;
      cursor: pointer;
    }

    .delete-icon {
      color: #dc3545;
      cursor: pointer;
    }

    .view-order-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .btn-download {
      background-color: #007980;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-download i {
      font-size: 14px;
    }
    .action-icons {
  display: flex;
  gap: 12px; /* adjust spacing as needed */
  justify-content: center;
  align-items: center;
}
.nav-item.active {
  background-color: rgba(255, 255, 255, 0.25); /* subtle highlight */
}
.back-heading {
  text-decoration: none;
  color: inherit;
}

.back-heading h1 {
  margin: 0;
  transition: color 0.2s ease;
}

.back-heading:hover h1 {
  color: #127285;
  cursor: pointer;
  transform: translateX(-2px);
}

  </style>
</head>
<body>
 <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">
        <img src="{{ url_for('static', filename='assets/LOGO.png') }}" alt="Logo" />
      </div>
      <nav>
        <ul>
          <li class="nav-item">
  <a href="{{ url_for('dashboard') }}" style="color: white; text-decoration: none;">
    <i class="fas fa-th-large"></i> <span> Dashboard</span>
  </a>
</li>
          <li class="nav-item">
  <a href="/add-order" style="color: white; text-decoration: none;">
    <i class="fas fa-plus-circle"></i> Add New Order
  </a>
</li>

          <li class="nav-item">
  <a href="{{ url_for('clients') }}" style="color: white; text-decoration: none;">
    <i class="fas fa-user"></i> Clients</a>
</li>

<li class="nav-item active">
  <a href="{{ url_for('view_orders') }}" style="color: white; text-decoration: none;">
    <i class="fas fa-file-alt"></i> View Sales Order</a>
</li>

          <li class="nav-item">
  <a href="javascript:void(0);" onclick="showComingSoon(this)" style="color: white; text-decoration: none;">
    <i class="fas fa-receipt"></i> <span> Sales Invoice</span>
  </a>
</li>

<li class="nav-item">
  <a href="javascript:void(0);" onclick="showReportSection(this)" style="color: white; text-decoration: none;">
    <i class="fas fa-chart-bar"></i> <span> Report</span>
  </a>
</li>

        </ul>
</nav>
<li class="nav-item logout">
  <a href="/" style="color: white; text-decoration: none;">
    <i class="fas fa-sign-out-alt"></i> <span> Log Out</span>
  </a>
</li>
</aside>

  <!-- Main Content -->
  <main class="main-content">
    <a href="{{ url_for('dashboard') }}" class="back-heading">
  <h1>â—€ View Sales Order</h1>
</a>

    <div class="custom-filter-group">
      <div class="custom-dropdown">
        <button class="dropdown-btn" onclick="event.stopPropagation(); toggleDropdown('order-dropdown')">Order ID <i class="fas fa-chevron-down"></i></button>
        <div class="dropdown-content" id="order-dropdown" onclick="event.stopPropagation()">
  <input type="text" placeholder="Search Order ID..." oninput="filterTableByInput(this.value, 'orderId')">
</div>
      </div>
      <div class="custom-dropdown">
        <button class="dropdown-btn" onclick="event.stopPropagation(); toggleDropdown('company-dropdown')">Company <i class="fas fa-chevron-down"></i></button>

        <div class="dropdown-content" id="company-dropdown" onclick="event.stopPropagation()">
  <input type="text" placeholder="Search Company..." oninput="filterTableByInput(this.value, 'company')">
</div>

      </div>
    </div>

    <div class="table-wrapper">
      <table id="sales-table">
        <thead>
        <tr>
          <th>Order ID</th>
          <th>Client name</th>
          <th>Company</th>
          <th>Project</th>
          <th>PO Base Value</th>
          <th>Profit</th>
          <th>Action</th>
        </tr>
        </thead>
        <tbody id="sales-table-body">
  <!-- Dynamic rows will be inserted here -->
</tbody>

      </table>
    </div>

    <div class="view-order-actions">
      <button class="btn-download" onclick="downloadTableCSV('sales-table')">
        <i class="fas fa-download"></i> Download
      </button>
    </div>
  </main>
</div>

<script>
  const ordersData = [];

  // Toggle dropdown visibility
  function toggleDropdown(id) {
    document.querySelectorAll(".dropdown-content").forEach(d => {
      if (d.id !== id) d.style.display = "none";
    });
    const dd = document.getElementById(id);
    dd.style.display = dd.style.display === "block" ? "none" : "block";
  }

  // Close dropdowns when clicking outside
  window.addEventListener("click", () => {
    document.querySelectorAll(".dropdown-content").forEach(d => d.style.display = "none");
  });

  // Populate dropdown lists dynamically
  
  function filterTableByInput(searchText, columnKey) {
  const rows = document.querySelectorAll("#sales-table tbody tr");
  searchText = searchText.toLowerCase();

  rows.forEach(row => {
    const colText = columnKey === "orderId"
      ? row.querySelector("td:nth-child(1)").textContent.toLowerCase()
      : row.querySelector("td:nth-child(3)").textContent.toLowerCase();

    row.style.display = colText.includes(searchText) ? "" : "none";
  });
}


  // Filter dropdown list items
  function filterDropdown(input, listId) {
  const filter = input.value.toLowerCase();
  const items = document.getElementById(listId).querySelectorAll("li");

  items.forEach(item => {
    const text = item.textContent.toLowerCase();
    item.style.display = text.includes(filter) ? "" : "none";
  });

  // Also filter table rows
  const columnKey = listId === "order-list" ? "orderId" : "company";
  filterTablePartial(columnKey, filter);
}

function filterTablePartial(columnKey, value) {
  const rows = document.querySelectorAll("#sales-table tbody tr");

  rows.forEach(row => {
    const colText = columnKey === "orderId"
      ? row.querySelector("td:nth-child(1)").textContent.trim().toLowerCase()
      : row.querySelector("td:nth-child(3)").textContent.trim().toLowerCase();

    row.style.display = colText.includes(value) ? "" : "none";
  });
}

  // Filter table rows by orderId or company
  function filterTable(columnKey, value) {
    const rows = document.querySelectorAll("#sales-table tbody tr");
    rows.forEach(row => {
      const colText = columnKey === "orderId"
        ? row.querySelector("td:nth-child(1)").textContent.trim()
        : row.querySelector("td:nth-child(3)").textContent.trim();

      row.style.display = colText === value ? "" : "none";
    });
  }

  // Download Excel file for specific order
  function downloadOrderExcel(orderId) {
    window.location.href = `/api/download/order/${orderId}`;
  }

  // Download entire table as CSV
  function downloadTableCSV(tableId) {
    const table = document.getElementById(tableId);
    let csv = [];
    const rows = table.querySelectorAll("tr");
    rows.forEach(row => {
      const cols = row.querySelectorAll("th, td");
      const rowData = Array.from(cols).map(col => `"${col.innerText.trim()}"`);
      csv.push(rowData.join(","));
    });

    const blob = new Blob([csv.join("\n")], { type: "text/csv" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "sales_orders.csv";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  // Delete order from backend and frontend
  async function deleteOrder(orderId, iconElement) {
    if (!confirm("Are you sure you want to delete this order?")) return;

    try {
      const response = await fetch(`/api/delete_order/${orderId}`, {
        method: "DELETE"
      });

      if (response.ok) {
        const row = iconElement.closest("tr");
        row.remove();
        alert("Order deleted successfully.");
      } else {
        alert("Failed to delete the order.");
      }
    } catch (error) {
      console.error("Error deleting order:", error);
      alert("An error occurred while deleting the order.");
    }
  }

  // Load sales order data and populate table
  async function loadSalesOrders() {
    try {
      const response = await fetch('/api/orders');
      const data = await response.json();
      const tbody = document.getElementById('sales-table-body');
      tbody.innerHTML = '';

      ordersData.length = 0; // Clear previous dummy data

      data.forEach(row => {
        const {
          order_id,
          client_name,
          company,
          project,
          po_amount,
          profit
        } = row;

        // Push live data to ordersData array
        ordersData.push({ orderId: order_id, company });

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${order_id}</td>
          <td>${client_name}</td>
          <td>${company}</td>
          <td>${project}</td>
          <td>â‚¹${parseFloat(po_amount || 0).toLocaleString()}</td>
          <td>â‚¹${parseFloat(profit || 0).toLocaleString()}</td>
          <td>
            <div class="action-icons">
              
              <i class="fas fa-trash delete-icon" title="Delete" onclick="deleteOrder(${order_id}, this)"></i>
              <i class="fas fa-download download-icon" title="Download" onclick="downloadOrderExcel(${order_id})"></i>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });

      populateDropdowns(); // Now will populate using actual live orders
    } catch (error) {
      console.error("Failed to load sales orders:", error);
    }
  }

  // Load orders on page load
  window.onload = loadSalesOrders;
  
</script>

</body>
</html>
