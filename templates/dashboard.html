<!DOCTYPE html>
<html lang="en">
<head>
  
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.cdnfonts.com/css/sf-pro-display" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>




  <style>
    
    :root {
      --teal: #127285;
      --bg: #f5f6f8;
      --card-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
     html, body {
      height: 100%;
    }

  
   

    * {
      font-family: SF Pro Display, sans-serif;
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    .container {
      display: flex;
      width: 100%;
      height: 100vh;
    }

    /* Sidebar */

  .sidebar {
  width: 280px;
  background-color: #0A7386;
  color: white;
  display: flex;
  flex-direction: column;
  padding: 20px 0;
}

    .sidebar .logo img {
      width: 245px;
      margin: 0 auto 20px;
      display: block;
    }

    .sidebar nav ul {
  list-style: none;
  padding: 0;
  margin: 0;
}
    .sidebar nav ul li {
  padding: 12px 30px;
  cursor: pointer;
  font-size: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: background 0.3s;
}

        .nav-item i,
.logout i {
  font-size: 18px;
}
.nav-item i,
.logout i {
  font-size: 18px;
  margin-right: 8px; /* spacing between icon and text */
  vertical-align: middle;
  width: 18px;        /* uniform width */
  height: 22px;       /* uniform height */
  display: inline-block;
  margin-bottom: 1  0px;
}

    .nav-item:hover {
      background-color: rgba(255, 255, 255, 0.25);
      cursor: pointer;
    }

    .logout {
      padding: 12px 30px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: auto;
    }

    /* Sidebar text and icon color */

    .sidebar nav ul li a,
    .sidebar nav ul li a i,
    .sidebar nav ul li a span,
    .sidebar .logout a,
    .sidebar .logout a i,
    .sidebar .logout a span {
      color: white;
      text-decoration: none;
      
    }

    .sidebar nav ul li a:hover,
    .sidebar .logout a:hover {
      color: white;
    }

    .main {
      flex: 1;
      padding: 21px;
      background: white;
      overflow-y: hidden;
       opacity: 0;
  animation: fadeIn 1.2s ease-out forwards;
    }

    @keyframes fadeIn {
  to {
    opacity: 1;
  }
}

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .metrics {
      
      display: flex;
      gap: 42px;
      margin-top: 9px;
      
      flex-wrap: wrap;
      margin-bottom: 17px;
    }

    .metric-box {
      flex: 1;
      min-width: 180px;
      padding: 14px;
      background: white;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .metric-box i {
      background: var(--teal);
      color: white;
      width: 40px;
      height: 40px;
      font-size: 18px;
      border-radius: 8px;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-shrink: 0;
    }
    .metric-box:hover {
  transform: translateY(-4px); /* Slight lift */
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12); /* Deeper shadow */
  transition: all 0.3s ease;
  
}

    h3 {
      margin: 20px 0 0px;
      font-size: 1.2rem;
    }

    .job-status-panel {
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 15px;
      background: #fff;
      box-shadow: var(--card-shadow);
    }

    .job-status {
      display: flex;
      gap: 24px;
      align-items: flex-start;
    }

    .status-cards {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(2, minmax(180px, 1fr));
      gap: 20px;
    }

    .status-box {
      padding: 5px;
      border-radius: 12px;
      background: rgb(255, 255, 255);
      position: relative;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: transform 0.3s ease; 
    }
    .status-box:hover {
  transform: scale(1.03); /* Slight Zoom */
}

    .status-box h4,
    .status-box span {
      color: #000 !important;
    }

    .status-box h4 {
      font-size: 1rem;
      font-weight: 600;
    }

    .status-box span {
      font-size: 1.6rem;
      font-weight: bold;
      align-self: flex-end;
    }

    .status-box img.status-icon {
      position: absolute;
      bottom: 12px;
      left: 14px;
      width: 40px;
      height: 40px;
    }

    .open { border: 1px solid #c0e6c0; box-shadow: 0 2px 8px rgba(99, 176, 124, 0.2); }
    .in-progress { border: 1px solid #b0d8f5; box-shadow: 0 2px 8px rgba(109, 174, 248, 0.2); }
    .on-hold { border: 1px solid #ffe0c5; box-shadow: 0 2px 8px rgba(250, 178, 139, 0.2); }
    .delayed { border: 1px solid #f8e0a5; box-shadow: 0 2px 8px rgba(241, 199, 113, 0.2); }
    .closed { border: 1px solid #ddd; box-shadow: 0 2px 8px rgba(184, 184, 184, 0.2); }
    .cancelled { border: 1px solid #f5c1c6; box-shadow: 0 2px 8px rgba(238, 162, 168, 0.2); }

    .chart-container {
      width: 320px;
      text-align: center;
      margin-left: auto;
    }
    /* Download Button */

    .download-btn {
      margin-top: 12px;
      padding: 10px 16px;
      background-color: var(--teal);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    /* Sort Button */

    .sort-btn {
      color: #fff;
      background-color: var(--teal);
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }
    .nav-item.active {
  background-color: rgba(255, 255, 255, 0.25); /* subtle highlight */
}

.sort-strip-wrapper {
  display: flex;
  align-items: center;
  position: relative;
  color:#000000;
}

.date-strip {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-right: 12px;
  opacity: 0;
  transform: translateX(-20px);
  transition: all 0.3s ease;
  pointer-events: none;
  color:#000000;
}

.date-strip.show {
  opacity: 1;
  transform: translateX(0);
  pointer-events: auto;
  color:#000000;
}

.date-strip label {
  font-size: 14px;
  color: #000000;
}

.date-strip input[type="date"] {
  padding: 5px 8px;
  border-radius: 4px;
  border: 1px solid #000000;
  font-size: 13px;
  color:#000000;
}

.sort-btn {
  background-color: #127285;
  color: white;
  border: none;
  padding: 8px 14px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 500;
}

.highlight-card {
  position: relative;
  z-index: 0;
  overflow: hidden;
  border: 2px solid transparent;
  border-radius: 12px;
  box-shadow: 0 0 6px 2px var(--run-color, #63b07c); /* ðŸ”† GLOW EFFECT */
  transition: box-shadow 0.3s ease-in-out;
}

.highlight-card::before {
  content: '';
  position: absolute;
  z-index: -1;
  top: -2px;
  left: -2px;
  width: calc(100% + 4px);
  height: calc(100% + 4px);
  background: linear-gradient(
    90deg,
    transparent,
    var(--run-color, #63b07c),
    transparent
  );
  background-size: 200% auto;
  animation: runBorder 2s linear infinite;
  border-radius: 14px;
}
@keyframes runBorder {
  0% {
    background-position: 200% 0;
  }
  100% {
    background-position: -200% 0;
  }
}
#card-open.highlight-card {
  --run-color: #bbf4cd; /* green */
}

#card-in_progress.highlight-card {
  --run-color: #adcff6; /* blue */
}

#card-on_hold.highlight-card {
  --run-color: #f8c7ad; /* orange */
}

#card-delayed.highlight-card {
  --run-color: #f7e9cb; /* yellow */
}

#card-closed.highlight-card {
  --run-color: #cecccc; /* grey */
}

#card-cancelled.highlight-card {
  --run-color: #f4c1c5; /* red-pink */
}



.highlight-card {
  transform: scale(1.05);
  z-index: 2;
  transition: all 0.2s ease;
}
.sort-strip-wrapper .sort-btn {
  margin-left: 380px; 
  margin-top: -10px;/* Adjust this value as needed */
}
.expired-po-row {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: nowrap;
  white-space: nowrap;
}


/* Responsive for laptops/desktops only (min-width: 900px) */

@media (max-width: 1600px) {
  .container {
    max-width: 100vw;
  }
  .main {
    padding: 16px;
  }
  .metrics {
    gap: 24px;
  }
  .status-cards {
    gap: 14px;
  }
  .chart-container {
    max-width: 320px;
  }
}

@media (max-width: 1200px) {
  .sidebar {
    width: 200px;
  }
  .sidebar .logo img {
    width: 140px;
  }
  .main {
    padding: 10px;
  }
  .metrics {
    gap: 12px;
    flex-wrap: wrap;
  }
  .metric-box {
    min-width: 140px;
    font-size: 0.95rem;
    padding: 10px;
  }
  .status-cards {
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .chart-container {
    max-width: 220px;
  }
}

@media (max-width: 1000px) {
  .container {
    flex-direction: column;
    height: auto;
  }
  .sidebar {
    flex-direction: row;
    width: 100vw;
    min-width: 0;
    padding: 10px 0;
    height: auto;
  }
  .main {
    padding: 8px 2vw;
  }
  .metrics {
    flex-direction: column;
    gap: 8px;
  }
  .status-cards {
    grid-template-columns: 1fr;
    gap: 8px;
  }
  .chart-container {
    max-width: 100vw;
    margin: 0 auto;
  }
}
@media (max-width: 768px) {
  .container {
    flex-direction: column;
    height: auto;
  }

  /* Sidebar */
  .sidebar {
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    height: auto;
    padding: 10px 15px;
  }

  .sidebar .logo img {
    width: 120px;
  }

  .sidebar nav ul {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    padding: 0;
    margin: 0;
  }

  .sidebar nav ul li {
    font-size: 0.9rem;
    padding: 8px 12px;
  }

  .main {
    padding: 10px 5vw;
  }

  .metrics {
    flex-direction: column;
    gap: 8px;
  }

  .metric-box {
    width: 100%;
    font-size: 0.9rem;
    padding: 10px;
  }

  .status-cards {
    grid-template-columns: 1fr;
    gap: 10px;
  }

  .chart-container {
    max-width: 100%;
    margin: 0 auto;
  }

  .filter-section select {
    width: 100%;
    margin-bottom: 10px;
  }

  .header h1 {
    font-size: 20px;
  }

  .logout {
    font-size: 0.9rem;
  }
}

.has-submenu {
  position: relative;
}

.has-submenu .submenu {
  display: none;
  list-style: none;
  background-color: #0a6a7c;
  position: absolute;
  top: 100%;
  left: 0%;
  width: 280px;
  border-radius: 0 0 12px 12px;
  z-index: 999;
  padding: 8px 0;
}
.has-submenu:hover .submenu {
  display: block;
}

.submenu li {
  padding: 10px 30px;
  font-size: 14px;
  color: white;
  cursor: pointer;
   margin-bottom: -7px; /* âœ… Add spacing between items */
}

.submenu li:hover {
  background-color: rgba(255, 255, 255, 0.1);
}
.submenu-arrow {
  margin-left: auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* SIDEBAR AND OVERALL DASHBOARD WITH METRIC CARDS , CHARTS  */
  /* Expired PO Modal sticky header and scrollable table */
  .expired-po-modal-header {
    position: sticky;
    top: 0;
    z-index: 2;
    background: white;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 32px 24px 12px 24px;
    border-radius: 10px 10px 0 0;
    border-bottom: 1px solid #eee;
  }
  #expired-po-table-container {
    overflow-y: auto;
    max-height: calc(80vh - 70px);
    padding: 0 24px 24px 24px;
  }
  /* Expired PO Modal sticky header and scrollable table */
  .expired-po-modal-header {
    position: sticky;
    top: 0;
    z-index: 2;
    background: white;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 32px 24px 12px 24px;
    border-radius: 10px 10px 0 0;
    border-bottom: 1px solid #eee;
  }
  #expired-po-table-container {
    overflow-y: auto;
    max-height: calc(80vh - 70px);
    padding: 0 24px 24px 24px;
  }


  /* ===== START: New styles for the email dropdown ===== */
#email-dropdown-list {
  display: none;
  position: absolute;
  background-color: #f9f9f9;
  min-width: 360px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
  z-index: 10001; /* Must be higher than the modal's z-index */
  max-height: 150px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

#email-dropdown-list div {
  color: black;
  padding: 8px 12px;
  text-decoration: none;
  display: block;
  cursor: pointer;
}

#email-dropdown-list div:hover {
  background-color: #f1f1f1;
}
/* ===== END: New styles for the email dropdown ===== */
  </style>
</head>
<body>
  <div class="container">
   <!-- =================================================================== -->
<!-- START: New & Improved Sidebar with Bottom-Aligned Support/Logout    -->
<!-- =================================================================== -->
<aside class="sidebar" style="display: flex; flex-direction: column; justify-content: space-between;">

  <!-- Top Section: Logo and Main Navigation -->
  <div>
    <div class="logo">
      <img src="{{ url_for('static', filename='assets/LOGO.png') }}" alt="Logo" />
    </div>

    <nav>
      <ul>
        <li class="nav-item"><a href="{{ url_for('dashboard') }}"><i class="fas fa-th-large"></i> <span>Dashboard</span></a></li>
        <li class="nav-item"><a href="/add-order"><i class="fas fa-plus-circle"></i> <span>Add New Order</span></a></li>
        <li class="nav-item"><a href="{{ url_for('clients') }}"><i class="fas fa-user"></i> <span>Clients</span></a></li>
        <li class="nav-item"><a href="{{ url_for('view_orders') }}"><i class="fas fa-file-alt"></i> <span>View Sales Order</span></a></li>

        <li class="nav-item has-submenu" onclick="toggleSubmenu(this)">
          <div class="report-toggle" style="display: flex; align-items: center; width: 100%; color: white;">
            <i class="fas fa-chart-bar"></i>
            <span style="margin-left: 6px;">Report</span>
            <i class="fas fa-chevron-down submenu-arrow" style="margin-left: auto;"></i>
          </div>
          <ul class="submenu">
            <li onclick="window.location.href='/report'" class="submenu-item">
              <i class="fas fa-chart-bar"></i>
              <span style="margin-left: 8px;">Sales Order Overview</span>
            </li>
            <li onclick="window.location.href='/po-overview'" class="submenu-item active">
              <i class="fas fa-chart-bar"></i>
              <span style="margin-left: 8px;">POâ€™s Overview</span>
            </li>
            <li onclick="window.location.href='/growth-overview'" class="submenu-item">
              <i class="fas fa-chart-bar"></i>
              <span style="margin-left: 8px;">Growth Overview</span>
            </li>
          </ul>
        </li>
      </ul>
    </nav>
  </div>

  <!-- Bottom Section: Support and Logout are grouped here -->
  <div style="display: flex; flex-direction: column;">
    <li class="nav-item" style="list-style: none; flex-direction: column; align-items: flex-start; gap: 8px; padding-left: 26px; margin-bottom: 7px;">
        <button onclick="createSupportTicket()" style="background: none; border: none; color: white; padding: 0; font: inherit; cursor: pointer; display: flex; align-items: center;">
            <i class="fas fa-envelope" style="margin-right: 8px;"></i>
            <span>Support</span>
        </button>
        <span style="color: white; font-size: 14px; margin-left: 1px;">dt@activusdesignbuild.in</span>
    </li>

    <li class="nav-item logout">
      <a href="/logout"><i class="fas fa-sign-out-alt"></i> <span>Log Out</span></a>
    </li>
  </div>

</aside>
<!-- =================================================================== -->
<!-- END: New & Improved Sidebar                                         -->
<!-- =================================================================== -->

    <main class="main">
      <div class="topbar">
        <div>
          <h2>{{ greeting }} {{ user_name }}</h2>
          <p>Welcome to Activus Sales Order Tracker Portal Dashboard!</p>
          <div style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 0;">
            <!-- Expired POs card in top-right white space, perfectly positioned -->
<div style="position: absolute; top: 30px; right: 190px; z-index: 1;">
  <div class="metric-box expired-po-metric" style="min-width: 220px; background: #ffeded; border: 2px solid #e74c3c; color: #e74c3c; cursor: pointer;" onclick="showExpiredPOModal()">
    <i class="fas fa-clock" style="background: #e74c3c; color: white;"></i>
    <div>
      Expired POs<br>
      <span style="font-size: 1.1em; font-weight: 600;">
        <span id="expired-pos-count">--</span>
        <span style="font-size: 0.95em; font-weight: 400;">POs</span>
        <span style="margin: 0 8px; font-size: 1em;">|</span>
        <span id="expired-pos-value">--</span>
      </span>
    </div>
  </div>
</div>
<!-- Expired PO Modal -->
<div id="expired-po-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:white; border-radius:10px; max-width:900px; width:90vw; max-height:80vh; overflow:hidden; padding:0; position:relative; display:flex; flex-direction:column;">
    <!-- Sticky header, close button, and share button -->
    <div class="expired-po-modal-header" style="position:sticky; top:0; z-index:2; background:white; display:flex; align-items:center; justify-content:space-between; padding:32px 24px 12px 24px; border-radius:10px 10px 0 0; border-bottom:1px solid #eee;">
      <h2 style="color:#e74c3c; margin:0;">Expired Purchase Orders</h2>
      <div style="display: flex; gap: 12px;">
        <button id="share-expired-po-btn" style="background: #e74c3c; color: white; border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 16px;">
          <i class="fas fa-paper-plane"></i> Share
        </button>
        <button onclick="closeExpiredPOModal()" style="background:none; border:none; font-size:22px; color:#e74c3c; cursor:pointer;"><i class='fas fa-times'></i></button>
      </div>
    </div>
    <!-- Scrollable table area -->
    <div id="expired-po-table-container" style="overflow-y:auto; max-height:calc(80vh - 70px); padding:0 24px 24px 24px;">
      <div style="text-align:center; color:#888;">Loading...</div>
    </div>
  </div>
</div>

<!-- START: New & Improved Share Expired PO Modal                       -->

<div id="share-po-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.45); z-index:10000; align-items:center; justify-content:center;">
  <div style="background:white; border-radius:14px; max-width:420px; width:95vw; box-shadow:0 8px 32px rgba(18,114,133,0.18); padding:0; position:relative; display:flex; flex-direction:column;">
    
    <!-- Modal Header -->
    <div style="padding:28px 28px 10px 28px; border-radius:14px 14px 0 0; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between;">
      <h3 style="margin:0; color:#e74c3c; font-weight:700;">Share Expired PO's <i class="fas fa-paper-plane" style="margin-left:8px;"></i></h3>
      <button onclick="closeSharePOModal()" style="background:none; border:none; font-size:22px; color:#e74c3c; cursor:pointer;"><i class='fas fa-times'></i></button>
    </div>
    
    <!-- Modal Body -->
    <div style="padding:22px 28px 24px 28px;">
      <label style="display:flex; align-items:center; gap:10px; margin-bottom:18px;">
        <input type="checkbox" id="send-copy-myself" style="accent-color:#e74c3c; width:20px; height:20px;">
        <span style="font-size:16px; color:#e74c3c; font-weight:500;">Send a copy to myself</span>
      </label>
      
      <!-- THIS IS THE NEW PART: Input with Dropdown Container -->
      <div style="position: relative;">
          <label style="font-size:15px; color:#333; font-weight:500; margin-bottom:8px; display:block;">Enter or select recipient(s):</label>
          <input type="text" id="recipient-emails" placeholder="Type or select from list..." style="width:100%; padding:10px 12px; border-radius:7px; border:1px solid #e74c3c; font-size:15px; margin-bottom:12px; outline:none;">
          <!-- The dropdown will be populated here by JavaScript -->
          <div id="email-dropdown-list"></div>
      </div>
      
      <div id="email-tags" style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom:12px;"></div>
      
      <button id="send-po-btn" style="width:100%; background:#e74c3c; color:white; border:none; border-radius:7px; padding:12px 0; font-size:16px; font-weight:600; cursor:pointer; box-shadow:0 2px 8px rgba(18,114,133,0.08); transition:background 0.2s;">
        <i class="fas fa-paper-plane"></i> Send
      </button>
      <div id="share-po-status" style="margin-top:10px; font-size:14px; color:#e74c3c; text-align:center; display:none;"></div>
    </div>
    
  </div>
</div>

<!-- END: New & Improved Share Expired PO Modal                         -->

<script>
// Modal open/close logic
function showExpiredPOModal() {
  document.getElementById('expired-po-modal').style.display = 'flex';
  loadExpiredPOTable();
}
function closeExpiredPOModal() {
  document.getElementById('expired-po-modal').style.display = 'none';
}
async function loadExpiredPOTable() {
  const container = document.getElementById('expired-po-table-container');
  container.innerHTML = '<div style="text-align:center; color:#888;">Loading...</div>';
  try {
    const res = await fetch('/api/orders');
    const orders = await res.json();
    const expired = orders.filter(po => po.status && po.status.toLowerCase() === 'delayed');
    if (expired.length === 0) {
      container.innerHTML = '<div style="text-align:center; color:#e74c3c;">No expired POs found.</div>';
      document.getElementById('expired-pos-count').textContent = 0;
      document.getElementById('expired-pos-value').textContent = 'â‚¹ 0';
      return;
    }
    document.getElementById('expired-pos-count').textContent = expired.length;
    const totalValue = expired.reduce((sum, po) => sum + Number(po.po_value || po.po_amount || 0), 0);
    document.getElementById('expired-pos-value').textContent = 'â‚¹ ' + totalValue.toLocaleString('en-IN', { maximumFractionDigits: 0 });

    // MODIFICATION: The 'Status' header is removed from this line.
    let table = `<table style="width:100%; border-collapse:collapse; font-size:15px;">
      <thead><tr style="background:#ffeaea; color:#e74c3c;">
        <th style="padding:8px; border:1px solid #e74c3c;">Order ID</th>
        <th style="padding:8px; border:1px solid #e74c3c;">Client</th>
        <th style="padding:8px; border:1px solid #e74c3c;">Company</th>
        <th style="padding:8px; border:1px solid #e74c3c;">Project</th>
        <th style="padding:8px; border:1px solid #e74c3c;">PO Number</th>
        <th style="padding:8px; border:1px solid #e74c3c;">PO Amount</th>
        <th style="padding:8px; border:1px solid #e74c3c;">PO Expiry Date</th>
      </tr></thead><tbody>`;

    expired.forEach(po => {
      // MODIFICATION: The 'Status' data cell is removed from this section.
      table += `<tr>
        <td style='padding:8px; border:1px solid #e74c3c;'>${po.order_id}</td>
        <td style='padding:8px; border:1px solid #e74c3c;'>${po.client_name || ''}</td>
        <td style='padding:8px; border:1px solid #e74c3c;'>${po.company || ''}</td>
        <td style='padding:8px; border:1px solid #e74c3c;'>${po.project || ''}</td>
        <td style='padding:8px; border:1px solid #e74c3c;'>${po.po_number || ''}</td>
        <td style='padding:8px; border:1px solid #e74c3c;'>â‚¹${Number(po.po_amount || 0).toLocaleString('en-IN')}</td>
        <td style='padding:8px; border:1px solid #e74c3c;'>${po.po_expiry_date ? new Date(po.po_expiry_date).toLocaleDateString('en-GB') : ''}</td>
      </tr>`;
    });
    table += '</tbody></table>';
    container.innerHTML = table;
  } catch (err) {
    container.innerHTML = '<div style="color:#e74c3c; text-align:center;">Failed to load expired POs.</div>';
  }
}
</script>
  <h3 style="margin: 20px 0 0;">Jobs Status</h3>
  <div class="sort-strip-wrapper" style="margin-top: 16px; margin-left: 20px;">
    <div class="date-strip" id="date-strip">
      <label>From: <input type="date" id="from-date"></label>
      <label>To: <input type="date" id="to-date"></label>
    </div>
    <button class="sort-btn" onclick="toggleStrip()">Filter <i class="fas fa-filter"></i></button>
  </div>
</div>
        </div>
      </div>

      
    <div class="metrics">
  <a href="{{ url_for('view_orders') }}" style="text-decoration: none; color: inherit;">
    <div class="metric-box">
      <i class="fas fa-clipboard-list"></i>
      <div>Total Jobs<br><strong id="total-jobs">--</strong></div>
    </div>
  </a>
  <a href="{{ url_for('view_orders') }}" style="text-decoration: none; color: inherit;">
    <div class="metric-box">
      <i class="fas fa-building"></i>
      <div>Total Companies<br><strong id="total-companies">--</strong></div>
    </div>
  </a>
  <a href="{{ url_for('clients') }}" style="text-decoration: none; color: inherit;">
    <div class="metric-box">
      <i class="fas fa-users"></i>
      <div>Total Clients<br><strong id="total-clients">--</strong></div>
    </div>
  </a>
  <a href="{{ url_for('report') }}" style="text-decoration: none; color: inherit;">
    <div class="metric-box">
      <i class="fas fa-chart-line"></i>
      <div>Sales Value<br><strong id="total-sales">--</strong></div>
    </div>
  </a>
</div>

      
      <div class="job-status-panel">
        <div class="job-status">
          <div class="status-cards">
            <div class="status-box open" id="card-open">
  <h4>Open Jobs</h4>
  <span id="status-open-value" style="font-size: 0.8rem; color: #127285; font-weight: 500; position: absolute; top: 5px; left: 140px;"></span>
  <h6 style="margin-left: 210px; margin-top: -10px;">Sales Value</h6>
  <span id="status-open" style="font-size: 1.4rem; font-weight: 600; color: #000;"></span>
  <h6 style="margin-left: 210px; margin-top: -10px;">No. of Sales</h6>
  <img src="{{ url_for('static', filename='assets/open.png') }}" class="status-icon" alt="Open Icon">
</div>

<div class="status-box in-progress" id="card-in_progress">
  <h4>In Progress Jobs</h4>
  <span id="status-in_progress-value" style="font-size: 0.8rem; color: #127285; font-weight: 500; position: absolute; top: 5px; left: 150px;"></span>
  <h6 style="margin-left: 210px; margin-top: -10px;">Sales Value</h6>
  <span id="status-in_progress" style="font-size: 1.4rem; font-weight: 600; color: #000;"></span>
  <h6 style="margin-left: 210px; margin-top: -10px;">No. of Sales</h6>
  <img src="{{ url_for('static', filename='assets/in-progress.png') }}" class="status-icon" alt="In Progress Icon">
</div>

<div class="status-box on-hold" id="card-on_hold">
  <h4>On Hold Jobs</h4>
  <span id="status-on_hold-value" style="font-size: 0.8rem; color: #127285; font-weight: 500; position: absolute; top: 5px; left: 176px;"></span>
  <h6 style="margin-left: 210px; margin-top: -10px;">Sales Value</h6>
  <span id="status-on_hold" style="font-size: 1.4rem; font-weight: 600; color: #000;"></span>
  <h6 style="margin-left: 210px; margin-top: -10px;">No. of Sales</h6>
  <img src="{{ url_for('static', filename='assets/on-hold.png') }}" class="status-icon" alt="On Hold Icon">
</div>

<div class="status-box delayed" id="card-delayed">
  <h4>Delayed Jobs</h4>
  <span id="status-delayed-value" style="font-size: 0.8rem; color: #127285; font-weight: 500; position: absolute; top: 5px; left: 148px;"></span>
  <h6 style="margin-left: 210px; margin-top: -10px;">Sales Value</h6>
  <span id="status-delayed" style="font-size: 1.4rem; font-weight: 600; color: #000;"></span>
  <h6 style="margin-left: 210px; margin-top: -10px;">No. of Sales</h6>
  <img src="{{ url_for('static', filename='assets/delayed.png') }}" class="status-icon" alt="Delayed Icon">
</div>

<div class="status-box closed" id="card-closed">
  <h4>Closed Jobs</h4>
  <span id="status-closed-value" style="font-size: 0.8rem; color: #127285; font-weight: 500; position: absolute; top: 5px; left: 158px;"></span>
  <h6 style="margin-left: 210px; margin-top: -10px;">Sales Value</h6>
  <span id="status-closed" style="font-size: 1.4rem; font-weight: 600; color: #000;"></span>
  <h6 style="margin-left: 210px; margin-top: -10px;">No. of Sales</h6>
  <img src="{{ url_for('static', filename='assets/closed.png') }}" class="status-icon" alt="Closed Icon">
</div>

<div class="status-box cancelled" id="card-cancelled">
  <h4>Cancelled Jobs</h4>
  <span id="status-cancelled-value" style="font-size: 0.8rem; color: #127285; font-weight: 500; position: absolute; top: 5px; left: 159px;"></span>
  <h6 style="margin-left: 210px; margin-top: -10px;">Sales Value</h6>
  <span id="status-cancelled" style="font-size: 1.4rem; font-weight: 600; color: #000;"></span>
  <h6 style="margin-left: 210px; margin-top: -10px;">No. of Sales</h6>
  <img src="{{ url_for('static', filename='assets/cancel.png') }}" class="status-icon" alt="Cancelled Icon">
</div>
<h5 class="expired-po-row" style="color: rgb(255, 255, 255); font-size: 15px;">
  <i class="fas fa-clock" style="margin-right: 6px;"></i>
  No. of Expired PO's:<span id="expired-po-count">--</span>
  <span style="margin: 0 8px; font-size: 15px;">|</span>
  PO Value:<span id="expired-po-value">--</span>
</h5>

          </div>
          <div class="chart-container">
            <canvas id="jobChart"></canvas>
            
            <button class="download-btn"><i class="fas fa-download"></i> Download</button>
          </div>
        </div>
      </div>
    </main>
  </div>



<script>
  window.currentUserEmail = "{{ email }}";
</script>
  <script>
    
     let jobChartInstance = null;

  const centerText = {
    id: 'centerText',
    afterDraw: chart => {
      const { width, height, ctx } = chart;
      ctx.save();
      ctx.font = "bold 16px 'SF Pro Dis', sans-serif";
      ctx.fillStyle = "#333";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      if (chart.data.labels.length === 1 && chart.data.labels[0] === 'No Data') {
  ctx.fillText("No Data", width / 2, height / 2);
} else {
  ctx.fillText("Jobs", width / 2, height / 2 - 10);
  ctx.fillText("Status", width / 2, height / 2 + 10);
}

      ctx.restore();
    }
  };

  Chart.register(centerText, ChartDataLabels);

  const chartLabels = ['Open', 'In Progress', 'On Hold', 'Delayed', 'Closed', 'Cancelled'];
  const chartColors = ['#c0e6c0', '#b0d8f5', '#ffe0c5', '#f8e0a5', '#ddd', '#f5c1c6'];

  const chartConfig = {
    type: 'doughnut',
    data: {
      labels: chartLabels,
      datasets: [{
        data: [0.01, 0.01, 0.01, 0.01, 0.01, 0.01], // fallback initial values
        backgroundColor: chartColors,
        borderWidth: 0
      }]
    },
    options: {
      cutout: '50%',
      responsive: true,
      plugins: {
        legend: { display: false },
        datalabels: {
          color: '#333',
          font: { weight: 'bold', size: 14 },
       formatter: (value, context) => {
  const raw = context.chart.config.options.plugins.datalabels.rawCounts || [];
  const index = context.dataIndex;
  const total = raw.reduce((a, b) => a + b, 0);
  const count = raw[index] || 0;

  if (count === 0 || total === 0) return '';  // âœ… hide 0%
  const percent = (count / total) * 100;
  return `${percent.toFixed(1)}% (${count})`;

}
        }
      }
    },
    plugins: [centerText]
  };

  function createJobChart() {
    const ctx = document.getElementById('jobChart').getContext('2d');
    jobChartInstance = new Chart(ctx, chartConfig);
  }


// Call on page load
document.addEventListener('DOMContentLoaded', function() {
  loadExpiredPOTable();
});

function loadPoExpiryData() {
    const card = document.getElementById('poExpiryCardContent');
    const wasHidden = card && card.style.display === 'none';
    
    if (wasHidden) card.style.display = 'block'; // Show temporarily

    fetch('/get-po-expiry-details')
        .then(response => response.json())
        .then(data => {
            const expiryElem = document.getElementById('po-expiry-count');
            const totalElem = document.getElementById('po-total-count');
            if (expiryElem && totalElem) {
                expiryElem.textContent = data.expiring_soon;
                totalElem.textContent = data.total_orders;
            }
        })
        .catch(err => console.error("Error loading PO Expiry data:", err))
        .finally(() => {
            if (wasHidden && card) card.style.display = 'none'; // Re-hide if it was hidden
        });
}

  function updateJobChart() {
    fetch("/api/job-status-metrics")
      .then(res => res.json())
      .then(data => {
        const rawValues = [
          data.open,
          data.in_progress,
          data.on_hold,
          data.delayed,
          data.closed,
          data.cancelled
        ];
        // Store raw values for accurate label calculation
        chartConfig.originalValues = [...rawValues];
        // Replace zeros with small slice values (0.01) for visibility
        const adjustedData = rawValues.map(v => v === 0 ? 0.01 : v);
        jobChartInstance.data.datasets[0].data = adjustedData;
        jobChartInstance.update();
      })
      .catch(err => console.error("Failed to update chart data:", err));
  }

  // Init chart on load
  createJobChart();
  updateJobChart();

  setInterval(updateJobChart, 100);

 document.querySelector('.download-btn').addEventListener('click', async () => {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "mm", "a4");

  // 1. Get date filters (if any)
  const from = document.getElementById('from-date')?.value;
  const to = document.getElementById('to-date')?.value;
  const dateQuery = (from && to) ? `&from=${from}&to=${to}` : "";

  // 2. Capture chart as image
  const chartCanvas = document.getElementById("jobChart");
  const chartImage = chartCanvas.toDataURL("image/png");
  const chartWidth = 100;
  const rupee = "â‚¹";

  const chartAspectRatio = chartCanvas.width / chartCanvas.height;
  const chartHeight = chartWidth / chartAspectRatio;

  // 3. Add chart image to PDF
pdf.setFont("helvetica", "normal"); // âœ… Add this line to support â‚¹ symbol
pdf.setFontSize(16);
pdf.text("Job Status Report", 15, 20);

 const chartX = (pdf.internal.pageSize.getWidth() - chartWidth) / 2; // âœ… center X
pdf.addImage(chartImage, 'PNG', chartX, 25, chartWidth, chartHeight);


  // 4. Fetch and insert each job status section
  const statuses = [
    { label: "Open", key: "open" },
    { label: "In Progress", key: "in_progress" },
    { label: "On Hold", key: "on_hold" },
    { label: "Delayed", key: "delayed" },
    { label: "Closed", key: "closed" },
    { label: "Cancelled", key: "cancelled" },
  ];

  let yOffset = 25 + chartHeight + 10;

  for (const status of statuses) {
    const response = await fetch(`/api/jobs-by-status?status=${status.label}${dateQuery}`);
    const jobs = await response.json();

    if (jobs.length > 0) {
      const tableRows = jobs.map(job => [
        job.id,
        job.client,
        job.company,
        job.project,
      'Rs. ' + Number(job.po_amount).toLocaleString("en-IN", { maximumFractionDigits: 0 }),
        job.status,
        job.issued_by
      ]);

      pdf.setFontSize(13);
      pdf.text(`${status.label} Jobs (${jobs.length})`, 15, yOffset);

      pdf.autoTable({
        startY: yOffset + 5,
        head: [['Order ID', 'Client', 'Company', 'Project', 'PO Amount', 'Status', 'Issued By']],
        body: tableRows,
        styles: {
          fontSize: 9,
          halign: 'center',
          valign: 'middle'
        },
        headStyles: {
          fillColor: [18, 114, 133],
          halign: 'center',
          valign: 'middle'
        },
        theme: 'striped',
        margin: { left: 15, right: 15 },
        didDrawPage: (data) => {
          yOffset = data.cursor.y + 10;
        }
      });
    }
  }

  pdf.save("Job-Status-Report.pdf");
});



document.getElementById('jobChart').addEventListener('mousemove', function (evt) {
  const points = jobChartInstance.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);

  // Remove existing highlight
  document.querySelectorAll('.status-box').forEach(box => box.classList.remove('highlight-card'));

  if (points.length) {
    const index = points[0].index;
    const statusMap = ['open', 'in_progress', 'on_hold', 'delayed', 'closed', 'cancelled'];
    const statusKey = statusMap[index];
    const card = document.getElementById(`card-${statusKey}`);
    if (card) card.classList.add('highlight-card');
  }
});

document.getElementById('jobChart').addEventListener('mouseleave', function () {
  // Remove highlight when mouse leaves chart
  document.querySelectorAll('.status-box').forEach(box => box.classList.remove('highlight-card'));
});

/* Date */
function getDateParams() {
  const from = document.getElementById('from-date').value;
  const to = document.getElementById('to-date').value;
  const params = new URLSearchParams();
  if (from && to) {
    params.append("from", from);
    params.append("to", to);
  }
  return params.toString();
}

/* Dashboard Metrics */
function updateDashboardMetrics() {
  const query = getDateParams();
  fetch("/api/dashboard-metrics?" + query)
    .then(response => response.json())
    .then(data => {
      document.getElementById('total-jobs').textContent = (data.total_jobs ?? 0);
      document.getElementById('total-companies').textContent = (data.total_companies ?? 0);
      document.getElementById('total-clients').textContent = (data.total_clients ?? 0);

      const sales = Number(data.total_sales_value);
      document.getElementById('total-sales').textContent = isNaN(sales)
        ? 'â‚¹0'
        : 'â‚¹' + sales.toLocaleString('en-IN', { maximumFractionDigits: 0 });
    })
    .catch(err => {
      console.error("Error fetching dashboard metrics:", err);
      document.getElementById('total-jobs').textContent = 0;
      document.getElementById('total-companies').textContent = 0;
      document.getElementById('total-clients').textContent = 0;
      document.getElementById('total-sales').textContent = 'â‚¹0';
    });
}



// Load once on page load
updateDashboardMetrics();
// Refresh every 10 seconds
setInterval(updateDashboardMetrics, 10000);

/* Job status Metrics */
function updateJobStatusMetrics() {
  const from = document.getElementById('from-date')?.value;
  const to = document.getElementById('to-date')?.value;

  const params = new URLSearchParams();
  if (from && to) {
    params.append("from", from);
    params.append("to", to);
  }

  fetch(`/api/job-status-metrics?${params.toString()}`)
    .then(res => res.json())
    .then(data => {
      const statuses = [
        { key: 'open', label: 'Open' },
        { key: 'in_progress', label: 'In Progress' },
        { key: 'on_hold', label: 'On Hold' },
        { key: 'delayed', label: 'Delayed' },
        { key: 'closed', label: 'Closed' },
        { key: 'cancelled', label: 'Cancelled' }
      ];

      statuses.forEach(status => {
        // Value
        const valueSpan = document.getElementById(`status-${status.key}-value`);
        if (valueSpan) {
          valueSpan.innerHTML =
            data[`${status.key}_value`] !== undefined && data[`${status.key}_value`] !== null
              ? `<span style="font-size:1.0rem; font-weight:700; color:#127285;"></span>
                 <span style="font-size:1.0rem; font-weight:700; color:#127285; margin-left:4px;">
                  â‚¹ ${Number(data[`${status.key}_value`]).toLocaleString('en-IN', { maximumFractionDigits: 0 })}
                 </span>`
              : '--';
        }
        // Count
        const countSpan = document.getElementById(`status-${status.key}`);
        if (countSpan) {
          countSpan.textContent = data[status.key];
        }
      });

      // Chart update logic (unchanged)
      const rawCounts = [
        data.open,
        data.in_progress,
        data.on_hold,
        data.delayed,
        data.closed,
        data.cancelled
      ];

      const total = rawCounts.reduce((a, b) => a + b, 0);

      if (total === 0) {
        jobChartInstance.data.labels = ['No Data'];
        jobChartInstance.data.datasets[0].data = [1];
        jobChartInstance.data.datasets[0].backgroundColor = ['#f5f5f5'];
        jobChartInstance.data.datasets[0].borderColor = ['#127285'];
        jobChartInstance.data.datasets[0].borderWidth = 2;
        jobChartInstance.options.plugins.datalabels.display = false;
        jobChartInstance.update();
      } else {
        const filteredLabels = ['Open', 'In Progress', 'On Hold', 'Delayed', 'Closed', 'Cancelled'];
        const filteredColors = ['#c0e6c0', '#b0d8f5', '#ffe0c5', '#f8e0a5', '#ddd', '#f5c1c6'];

        jobChartInstance.data.labels = filteredLabels;
        jobChartInstance.data.datasets[0].backgroundColor = filteredColors;
        jobChartInstance.data.datasets[0].borderColor = [];
        jobChartInstance.data.datasets[0].borderWidth = 0;
        jobChartInstance.options.plugins.datalabels.display = true;

        jobChartInstance.config.options.plugins.datalabels.rawCounts = [...rawCounts];
        const adjusted = rawCounts.map((c) => c === 0 ? 0 : c);
        jobChartInstance.data.datasets[0].data = adjusted;
        jobChartInstance.update();
      }
    });
}

// Call both metric functions on load
updateDashboardMetrics();
updateJobStatusMetrics();

// Refresh both every 10 seconds
setInterval(updateDashboardMetrics, 10000);
setInterval(updateJobStatusMetrics, 10000);

function toggleStrip() {
  const strip = document.getElementById('date-strip');
  const fromInput = document.getElementById('from-date');
  const toInput = document.getElementById('to-date');

  // If it's already visible (second click)
  if (strip.classList.contains('show')) {
    strip.classList.remove('show');             // hide strip
    fromInput.value = "";                        // clear date fields
    toInput.value = "";
    updateDashboardMetrics();                    // reset to overall data
    updateJobStatusMetrics();
    updateExpiredPOMetricCard(); // <-- update on filter change
  } else {
    strip.classList.add('show');                 // show strip
  }
}

document.getElementById('from-date').addEventListener('change', () => {
  updateDashboardMetrics();
  updateJobStatusMetrics();
  updateExpiredPOMetricCard();
});

document.getElementById('to-date').addEventListener('change', () => {
  updateDashboardMetrics();
  updateJobStatusMetrics();
  updateExpiredPOMetricCard();
});
function toggleStrip() {
  const strip = document.getElementById('date-strip');
  const fromInput = document.getElementById('from-date');
  const toInput = document.getElementById('to-date');
  if (strip.classList.contains('show')) {
    strip.classList.remove('show');
    fromInput.value = "";
    toInput.value = "";
    updateDashboardMetrics();
    updateJobStatusMetrics();
    updateExpiredPOMetricCard(); 
  } else {
    strip.classList.add('show');
  }
}
document.getElementById('from-date').addEventListener('change', () => {
  updateDashboardMetrics();
  updateJobStatusMetrics();
  updateExpiredPOMetricCard();
});
document.getElementById('to-date').addEventListener('change', () => {
  updateDashboardMetrics();
  updateJobStatusMetrics();
  updateExpiredPOMetricCard();
});
function toggleStrip() {
  const strip = document.getElementById('date-strip');
  const fromInput = document.getElementById('from-date');
  const toInput = document.getElementById('to-date');
  if (strip.classList.contains('show')) {
    strip.classList.remove('show');
    fromInput.value = "";
    toInput.value = "";
    updateDashboardMetrics();
    updateJobStatusMetrics();
    updateExpiredPOMetricCard(); 
  } else {
    strip.classList.add('show');
  }
}
document.getElementById('from-date').addEventListener('change', () => {
  updateDashboardMetrics();
  updateJobStatusMetrics();
  updateExpiredPOMetricCard();
});
document.getElementById('to-date').addEventListener('change', () => {
  updateDashboardMetrics();
  updateJobStatusMetrics();
  updateExpiredPOMetricCard();
});
function updateExpiredPOStats(poList) {
  let expiredCount = 0;
  let expiredValue = 0;

  poList.forEach(po => {
    if (po.status && po.status.toLowerCase() === 'delayed') {
      expiredCount++;
      expiredValue += Number(po.po_value || 0);
    }
  });

  // Update DOM
  document.getElementById("expired-po-count").innerText = expiredCount;
  document.getElementById("expired-po-value").innerText = expiredValue.toLocaleString("en-IN");
}



/* Ping and session check (unchanged) */
setInterval(() => {
  fetch("/api/ping", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ page: window.location.pathname })
  });
}, 1000); // every 30 seconds

setInterval(() => {
  fetch('/api/check-session')
    .then(res => res.json())
    .then(data => {
      if (!data.valid) {
        // ðŸ” Redirect immediately to your Flask logout route
        window.location.href = '/logout';
      }
    })
    .catch(err => {
      console.error("Session check error", err);
    });
}, 1000);



// Show/hide share modal
document.getElementById('share-expired-po-btn').onclick = function() {
  document.getElementById('share-po-modal').style.display = 'flex';
  document.getElementById('share-po-status').style.display = 'none';
  // When the modal opens, fetch the user emails
  populateEmailDropdown();
};

function closeSharePOModal() {
  document.getElementById('share-po-modal').style.display = 'none';
}

const emailInput = document.getElementById('recipient-emails');
const emailTags = document.getElementById('email-tags');
const emailDropdown = document.getElementById('email-dropdown-list');
let emails = [];
let allUserEmails = []; // To store the fetched list of all users

// Function to fetch all user emails from the backend
async function populateEmailDropdown() {
    try {
        const response = await fetch('/api/get-all-user-emails');
        allUserEmails = await response.json();
        filterEmailDropdown(); // Initially show all users
    } catch (error) {
        console.error('Failed to fetch user emails:', error);
    }
}

// Function to filter and display the dropdown based on input
function filterEmailDropdown() {
    const filter = emailInput.value.toLowerCase();
    emailDropdown.innerHTML = '';
    const filteredEmails = allUserEmails.filter(email => 
        email.toLowerCase().includes(filter) && !emails.includes(email)
    );

    if (filteredEmails.length > 0) {
        filteredEmails.forEach(email => {
            const item = document.createElement('div');
            item.textContent = email;
            item.onclick = () => {
                addEmailTag(email);
            };
            emailDropdown.appendChild(item);
        });
        emailDropdown.style.display = 'block';
    } else {
        emailDropdown.style.display = 'none';
    }
}

emailInput.addEventListener('keyup', filterEmailDropdown);
emailInput.addEventListener('focus', filterEmailDropdown);

// Close dropdown if clicked outside
document.addEventListener('click', function(event) {
    if (!emailInput.contains(event.target) && !emailDropdown.contains(event.target)) {
        emailDropdown.style.display = 'none';
    }
});

// Add email tag logic (handles both typing and clicking)
function addEmailTag(emailValue) {
    const val = emailValue.trim();
    if (val && validateEmail(val) && !emails.includes(val)) {
        emails.push(val);
        renderEmailTags();
    }
    emailInput.value = '';
    emailDropdown.style.display = 'none';
}

emailInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' || e.key === ',') {
        e.preventDefault();
        addEmailTag(emailInput.value);
    }
});

function renderEmailTags() {
  emailTags.innerHTML = '';
  emails.forEach(email => {
    const tag = document.createElement('span');
    tag.textContent = email;
    tag.style = "background:#e74c3c;color:white;padding:4px 10px;border-radius:12px;font-size:14px;display:inline-flex;align-items:center;gap:6px;";
    const remove = document.createElement('span');
    remove.innerHTML = 'Ã—';
    remove.style = "margin-left:6px;cursor:pointer;font-weight:bold;";
    remove.onclick = () => {
      emails = emails.filter(e => e !== email);
      renderEmailTags();
    };
    tag.appendChild(remove);
    emailTags.appendChild(tag);
  });
}

function validateEmail(email) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

// Send PDF logic (remains the same)
document.getElementById('send-po-btn').onclick = async function() {
    // ... your existing send PDF logic here ...
    const statusDiv = document.getElementById('share-po-status');
    statusDiv.style.display = 'none';
    const sendMyself = document.getElementById('send-copy-myself').checked;
    let recipientList = [...emails];

    if (sendMyself && window.currentUserEmail && !recipientList.includes(window.currentUserEmail)) {
        recipientList.push(window.currentUserEmail);
    }

    if (recipientList.length === 0) {
        statusDiv.textContent = "Please enter at least one recipient email or check 'Send a copy to myself'.";
        statusDiv.style.display = 'block';
        return;
    }

    statusDiv.textContent = "Sending...";
    statusDiv.style.display = 'block';

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("p", "mm", "a4");
    pdf.setFont("helvetica", "normal");
    pdf.setFontSize(16);
    pdf.text("Expired Purchase Orders", 15, 20);

    const table = document.querySelector('#expired-po-table-container table');
    if (!table) {
        statusDiv.textContent = "No expired PO data to send.";
        return;
    }

    pdf.autoTable({
        startY: 28,
        html: table,
        styles: { fontSize: 10, halign: 'center', valign: 'middle' },
        headStyles: { fillColor: [231, 76, 60], halign: 'center', valign: 'middle' },
        theme: 'striped',
        margin: { left: 15, right: 15 }
    });

    const pdfBlob = pdf.output('blob');
    const formData = new FormData();
    formData.append('recipients', JSON.stringify(recipientList));
    formData.append('pdf', pdfBlob, 'ExpiredPOs.pdf');

    fetch('/api/send-expired-po-pdf', { method: 'POST', body: formData })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            statusDiv.textContent = "Sent successfully!";
            statusDiv.style.color = "#e74c3c";
            setTimeout(closeSharePOModal, 1200);
        } else {
            statusDiv.textContent = "Failed to send. Try again.";
            statusDiv.style.color = "#e74c3c";
        }
    })
    .catch(() => {
        statusDiv.textContent = "Error sending email.";
        statusDiv.style.color = "#e74c3c";
    });
};

// --- END: New Share Modal Logic ---

// You must set window.currentUserEmail from your backend (Flask) via Jinja
// Example: <script>window.currentUserEmail = "{{ user_email }}";</script>


 <script>
function updateExpiredPOMetricCard() {
  fetch('/api/orders')
    .then(res => res.json())
    .then(orders => {
      const expired = orders.filter(po => po.status && po.status.toLowerCase() === 'delayed');
      // Update top metric card
      const topCount = document.getElementById('expired-pos-count');
      const topValue = document.getElementById('expired-pos-value');
      // Update row below status cards
      const rowCount = document.getElementById('expired-po-count');
      const rowValue = document.getElementById('expired-po-value');
      const totalValue = expired.reduce((sum, po) => sum + Number(po.po_value || po.po_amount || 0), 0);
      if (topCount) topCount.textContent = expired.length;
      if (topValue) topValue.textContent = 'â‚¹ ' + totalValue.toLocaleString('en-IN', { maximumFractionDigits: 0 });
      if (rowCount) rowCount.textContent = expired.length;
      if (rowValue) rowValue.textContent = 'â‚¹ ' + totalValue.toLocaleString('en-IN', { maximumFractionDigits: 0 });
    })
    .catch(() => {
      const topCount = document.getElementById('expired-pos-count');
      const topValue = document.getElementById('expired-pos-value');
      const rowCount = document.getElementById('expired-po-count');
      const rowValue = document.getElementById('expired-po-value');
      if (topCount) topCount.textContent = 0;
      if (topValue) topValue.textContent = 'â‚¹ 0';
      if (rowCount) rowCount.textContent = 0;
      if (rowValue) rowValue.textContent = 'â‚¹ 0';
    });
}


/**
 * Called when the Support button is clicked.
 * It fetches a unique ticket ID from the server and then opens the user's email client.
 */
async function createSupportTicket() {
    try {
        const response = await fetch('/api/generate-support-ticket');
        const data = await response.json();

        if (data.ticket_id) {
            const recipient = 'dt@activusdesignbuild.in';
            const subject = `Support Ticket: ${data.ticket_id}`;
            
            // This creates the mailto link and programmatically "clicks" it
            window.location.href = `mailto:${recipient}?subject=${encodeURIComponent(subject)}`;
        } else {
            // Fallback in case of an error
            alert('Could not generate a support ticket ID. Please email dt@activusdesignbuild.in directly.');
        }
    } catch (error) {
        console.error("Failed to create support ticket:", error);
        alert('An error occurred. Please email dt@activusdesignbuild.in directly.');
    }
}

</script>

</body>
</html>